---
title: "Week 5 Practice: Data wrangling with tidyr"
output: html_document
---

```{r setup, include=FALSE}
# load libraries
library(tidyverse)
library(conflicted)
library(viridis)

# configure knit settings
knitr::opts_chunk$set(echo = TRUE)

# resolve package conflicts
filter <- dplyr::filter
select <- dplyr::select
```

# Practice: Data wrangling with `tidyr`

We'll use the dataset who for a tidying challenge this week! It's in the tidyr package for practice and gives World Health Organization data on tuberculosis (TB) cases. 

### Practice Instructions

This practice is slightly different than the previous one. Instead of separate questions, it guides you through the process of tidying a data table. So for each question, you'll need to either copy/paste the previous chunk into the next chunk to continue piping (Kelsey's preferred method) or assign the result to an object. 

#### Piping Example

Follow the instructions that are hypothetically here. For example, drop the Species column from iris

```{r}
iris %>% select(-Species)
```

Copy/paste the code from the chunk above and continue piping to follow the instructions here. For example, add  a column with categorical sepal size.

```{r}
iris %>% select(-Species) %>% 
  mutate(sepal_size_cat = case_when(Sepal.Width <= 2.8 ~ small, 
                                    Sepal.Width > 2.8 & Sepal.Width < 3.3 ~ medium,
                                    Sepal.Width >= 3.3 ~ large))
```

#### Saving as Object Example

Follow the instructions that are hypothetically here. For example, drop the Species column from iris

```{r}
iris %>% select(-Species) -> iris_no_species
```

Copy/paste the code from the chunk above and continue piping to follow the instructions here. For example, add  a column with categorical sepal size.

```{r}
iris_no_species %>% 
  mutate(sepal_size_cat = case_when(Sepal.Width <= 2.8 ~ small, 
                                    Sepal.Width > 2.8 & Sepal.Width < 3.3 ~ medium,
                                    Sepal.Width >= 3.3 ~ large)) -> iris_sepal_size
```

As usual before doing anything else, take a look at the table. What do you see that's not tidy? Try and list them yourself before looking at the answers below.

```{r}
who
```

Some reasons the table isn't tidy/feature of the table you should pay attention to are:

- The columns country, iso2, and iso3 look like they all specify the country, so they're redundant, but the columns are all single variables.
- The year column is also a variable, so this column is tidy!
- The columns new_sp_m014 to newrel_f65 look like they're values, not variables, because they have a repeated structure.

## tidying who
Follow the guiding instructions below to tidy who!

First, take care of the easiest tidying step and drop the redundant iso2 and iso3 columns.

```{r}
who %>% select(-iso2, -iso3)
```

We decided earlier that the columns new_sp_m014 to newrel_f65 are values of the same variable(s) so gather them together into two columns, one with the old column names and one with the counts that were in the columns. Name your two new columns "code" and "count" (or whatever you want to call the new columns, but they'll be referred to as code and count downstream)

```{r}
who %>% 
  select(-iso2, -iso3) %>%
  gather(code, count, `new_sp_m014`:`newrel_f65`)

### OR

who %>% 
  select(-iso2, -iso3) %>%
  gather(code, count, 3:58)
```

So what do the things in the code column mean? Thankfully, because this is a built-in dataset, you can find out by typing `?who` into the console. But what about in real life? Well you might have to talk to whoever generated the data, or read the documentation for a tool that generated a table or figure it out yourself or some combination of all of these. 

But here's what our data in the code column means:

1. The first three letters tell you whether the case of 

```{r}
who %>% 
  select(-iso2, -iso3) %>%
  gather(code, count, `new_sp_m014`:`newrel_f65`) %>% separate(code, into = c('new', 'case_type', 'sex_age'), sep = '_') %>% separate(sex_age, into = c('sex', 'age'), sep = 1) %>% group_by(case_type) %>% count
```

```{r}
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`)
```

```{r}
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`) %>%
  separate(code, into = c('new', 'tb_type', 'sex_age'), sep = '_')
```

```{r}
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`) %>%
  group_by(code) %>% count
```

```{r}
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`) %>%
  mutate(code = stringr::str_replace(code, 'newrel', 'new_rel'))
```

```{r}
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`) %>%
  mutate(code = stringr::str_replace(code, 'newrel', 'new_rel')) %>%
  group_by(code) %>% count
```

```{r}
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`) %>%
  mutate(code = stringr::str_replace(code, 'newrel', 'new_rel')) %>%
  separate(code, into = c('new', 'tb_type', 'sex_age'), sep = '_')
```

# check all the new columns

```{r}
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`) %>%
  mutate(code = stringr::str_replace(code, 'newrel', 'new_rel')) %>%
  separate(code, into = c('new', 'tb_type', 'sex_age'), sep = '_') %>% 
  group_by(new) %>% count()
```

```{r}
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`) %>%
  mutate(code = stringr::str_replace(code, 'newrel', 'new_rel')) %>%
  separate(code, into = c('new', 'tb_type', 'sex_age'), sep = '_') %>% 
  group_by(tb_type) %>% count()
```

```{r}
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`) %>%
  mutate(code = stringr::str_replace(code, 'newrel', 'new_rel')) %>%
  separate(code, into = c('new', 'tb_type', 'sex_age'), sep = '_') %>% 
  group_by(sex_age) %>% count()
```

```{r}
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`) %>%
  mutate(code = stringr::str_replace(code, 'newrel', 'new_rel')) %>%
  separate(code, into = c('new', 'tb_type', 'sex_age'), sep = '_') %>%
  separate(sex_age, into = c('sex', 'age'), sep = 1)
```

# check again

```{r}
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`) %>%
  mutate(code = stringr::str_replace(code, 'newrel', 'new_rel')) %>%
  separate(code, into = c('new', 'tb_type', 'sex_age'), sep = '_') %>%
  separate(sex_age, into = c('sex', 'age'), sep = 1) %>%
  group_by(sex) %>% count
```

```{r}
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`) %>%
  mutate(code = stringr::str_replace(code, 'newrel', 'new_rel')) %>%
  separate(code, into = c('new', 'tb_type', 'sex_age'), sep = '_') %>%
  separate(sex_age, into = c('sex', 'age'), sep = 1) %>%
  group_by(age) %>% count
```


# drop redundant columns

```{r}
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`) %>%
  mutate(code = stringr::str_replace(code, 'newrel', 'new_rel')) %>%
  separate(code, into = c('new', 'tb_type', 'sex_age'), sep = '_') %>%
  separate(sex_age, into = c('sex', 'age'), sep = 1) %>%
  select(-iso2, -iso3, -new)
```

# drop NAs

```{r}
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`) %>%
  mutate(code = stringr::str_replace(code, 'newrel', 'new_rel')) %>%
  separate(code, into = c('new', 'tb_type', 'sex_age'), sep = '_') %>%
  separate(sex_age, into = c('sex', 'age'), sep = 1) %>%
  select(-iso2, -iso3, -new) %>%
  na.omit()
```

# replace NAs with something reasonable

```{r}
# 0
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`) %>%
  mutate(code = stringr::str_replace(code, 'newrel', 'new_rel')) %>%
  separate(code, into = c('new', 'tb_type', 'sex_age'), sep = '_') %>%
  separate(sex_age, into = c('sex', 'age'), sep = 1) %>%
  select(-iso2, -iso3, -new) %>%
  replace_na(list(count = 0))

# no data
who %>% gather(code, count, `new_sp_m014`:`newrel_f65`) %>%
  mutate(code = stringr::str_replace(code, 'newrel', 'new_rel')) %>%
  separate(code, into = c('new', 'tb_type', 'sex_age'), sep = '_') %>%
  separate(sex_age, into = c('sex', 'age'), sep = 1) %>%
  select(-iso2, -iso3, -new) %>%
  replace_na(list(count = 'no_data')) 
```


